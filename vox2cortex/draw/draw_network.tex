\documentclass[border=8pt, multi, tikz]{standalone}
%\usepackage{blocks}
\usepackage{pgfplots}
\usetikzlibrary{intersections, pgfplots.fillbetween}
\pgfplotsset{compat=1.15}
\usepackage{import}
\subimport{../../../PlotNeuralNet/layers/}{init}
\usetikzlibrary{positioning,shapes,matrix}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvKOneColor{rgb:yellow,5}
\def\ResBlockColor{\ConvColor}
\def\ConvReluColor{rgb:yellow,5;red,5}
\def\PoolColor{rgb:red,1;black,0.3}
\def\FeatureColor{rgb:red,1}
\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
\def\UpsampleColor{rgb:blue,2}
\def\FcColor{rgb:blue,5;red,2.5;white,5}
\def\FcReluColor{rgb:blue,5;red,5;white,4}
\def\CatColor{rgb:magenta,5;black,7}
\def\GraphConvColor{rgb:green,5; white,2.5}
\def\GraphReluColor{rgb:green,5;red,2.5;black,5}


\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width =0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw Encoder
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% conv1
\pic[shift={(0,0,0)}] at (0,0,0) {Box={name=c1,%
	xlabel={"16","dummy"},fill=\ConvColor,%
        height=40,width=1,depth=40}};
% resblock1
\pic[shift={(2,0,0)}] at (c1-east) {RightBandedBox={name=rb1,%
	xlabel={{"16","16"}},zlabel=I,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=40,width={2,2},depth=40}};
%pool1
\pic[shift={(0,0,0)}] at (rb1-east) {Box={name=p1,%
        xlabel={"32","dummy"},fill=\PoolColor,opacity=0.5,height=32,width=2,depth=32}};
%%%%%%%%%%
% resblock2
\pic[shift={(2,0,0)}] at (p1-east) {RightBandedBox={name=rb2,%
	xlabel={{"32","32"}},zlabel=I/2,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=32,width={3,3},depth=32}};
%pool2
\pic[shift={(0,0,0)}] at (rb2-east) {Box={name=p2,%
        xlabel={"64","dummy"},fill=\PoolColor,opacity=0.5,height=24,width=4,depth=24}};
%%%%%%%%%%
% resblock3
\pic[shift={(2,0,0)}] at (p2-east) {RightBandedBox={name=rb3,%
	xlabel={{"64","64"}},zlabel=I/4,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=24,width={5,5},depth=24}};
%pool3
\pic[shift={(0,0,0)}] at (rb3-east) {Box={name=p3,%
        xlabel={"128","dummy"},fill=\PoolColor,opacity=0.5,height=16,width=8,depth=16}};
%%%%%%%%%%
% resblock4
\pic[shift={(2,0,0)}] at (p3-east) {RightBandedBox={name=rb4,%
	xlabel={{"128","128"}},zlabel=I/8,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=16,width={9,9},depth=16}};
%pool4
\pic[shift={(0,0,0)}] at (rb4-east) {Box={name=p4,%
	xlabel={"256","dummy"},fill=\PoolColor,opacity=0.5,height=8,width=16,depth=8}};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Bottleneck
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% conv5_1,conv5_2,conv5_3
\pic[shift={(1,0,0)}] at (p4-east) {RightBandedBox={name=rb5,caption=Bottleneck,%
	xlabel={{"256","256"}},zlabel=I/16,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	height=8,width={17,17},depth=8}};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Draw Decoder 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% unpool4, 
\pic[shift={(2,0,0)}] at (rb5-east) {Box={name=up4,%
	xlabel={{"64","dummy"}},fill=\UnpoolColor,opacity=0.5,height=16,width=4,depth=16}};
% resupblock4
\pic[shift={(0,0,0)}] at (up4-east) {RightBandedBox={name=urb4,%
	xlabel={{"64","64"}},zlabel=I/8,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=16,width={5,5},depth=16}};
%%% unpool3, 
\pic[shift={(2,0,0)}] at (urb4-east) {Box={name=up3,%
	xlabel={{"32","dummy"}},fill=\UnpoolColor,opacity=0.5,height=24,width=2,depth=24}};
% resupblock3
\pic[shift={(0,0,0)}] at (up3-east) {RightBandedBox={name=urb3,%
	xlabel={{"32","32"}},zlabel=I/4,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=24,width={3,3},depth=24}};
%%% unpool2, 
\pic[shift={(2,0,0)}] at (urb3-east) {Box={name=up2,%
	xlabel={{"16","dummy"}},fill=\UnpoolColor,opacity=0.5,height=32,width=1,depth=32}};
% resupblock2
\pic[shift={(0,0,0)}] at (up2-east) {RightBandedBox={name=urb2,%
	xlabel={{"16","16"}},zlabel=I/2,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=32,width={2,2},depth=32}};
%%% unpool1 
\pic[shift={(2,0,0)}] at (urb2-east) {Box={name=up1,%
	xlabel={{"8","dummy"}},fill=\UnpoolColor,opacity=0.5,height=40,width=1,depth=40}};
% resupblock1
\pic[shift={(0,0,0)}] at (up1-east) {RightBandedBox={name=urb1,%
	xlabel={{"8","8"}},zlabel=I,fill=\ResBlockColor,bandfill=\ConvReluColor,%
	opacity=0.5,height=40,width={2,2},depth=40}};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Classifier 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% final conv
\pic[shift={(1,0,0)}] at (urb1-east) {Box={name=cf,%
	xlabel={"2","dummy"},zlabel=I,fill=\ConvKOneColor,%
        opacity=0.5,height=40,width=1,depth=40}};
% upsamplefordeepsupervision2
\pic[shift={(0,-6,0)}] at (cf-south) {Box={name=uds2,%
	fill=\UpsampleColor,opacity=0.5,height=40,width=1,depth=40}};
% deepsupervision2
\pic[shift={(0,0,0)}] at (uds2-east) {Box={name=ds2,%
	xlabel={{"2", "dummy"}},fill=\ConvKOneColor,opacity=0.5,height=40,width=1,depth=40}};
% upsamplefordeepsupervision3
\pic[shift={(0,-6,0)}] at (uds2-south) {Box={name=uds3,%
	fill=\UpsampleColor,opacity=0.5,height=40,width=1,depth=40}};
% deepsupervision3
\pic[shift={(0,0,0)}] at (uds3-east) {Box={name=ds3,%
	xlabel={{"2", "dummy"}},fill=\ConvKOneColor,opacity=0.5,height=40,width=1,depth=40}};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Graph network
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pic[shift={(0,-13,0)}] at (rb5-anchor) {LeftBandedCylinder={name=grb0,%
	xlabel={{"256", "256","256"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	opacity=0.5,height=25,width={8,8,8},depth=25}};
%% step 1
\pic[shift={(-6,0,0)}] at (grb0-west) {LeftBandedCylinder={name=grb1,caption=x3,%
	xlabel={{"256", "256","256"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	opacity=0.5,height=25,width={4,4,4},depth=25}};
%%
%\pic[shift={(-2.5,0,0)}] at (grb1-west) {LeftBandedCylinder={name=gc1,%
	%xlabel={{"128","dummy"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	%opacity=0.5,height=25,width={4},depth=25}};
%%
\pic[shift={(-1,-6,0)}] at (grb1-west) {Cylinder={name=fv1,%
	xlabel={{"3","dummy"}},fill=\GraphConvColor,
	opacity=0.5,height=25,width={1},depth=25}};
%% step 2
\pic[shift={(-7.5,0,0)}] at (grb1-west) {LeftBandedCylinder={name=grb2,caption=x3,%
	xlabel={{"128", "128","128"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	opacity=0.5,height=25,width={3,3,3},depth=25}};
%%
%\pic[shift={(-2.5,0,0)}] at (grb2-west) {LeftBandedCylinder={name=gc2,%
	%xlabel={{"64","dummy"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	%opacity=0.5,height=25,width={3},depth=25}};
%%
\pic[shift={(-1,-6,0)}] at (grb2-west) {Cylinder={name=fv2,%
	xlabel={{"3","dummy"}},fill=\GraphConvColor,
	opacity=0.5,height=25,width={1},depth=25}};
%% step 3
\pic[shift={(-6.5,0,0)}] at (grb2-west) {LeftBandedCylinder={name=grb3,caption=x3,%
	xlabel={{"64", "64","64"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	opacity=0.5,height=25,width={2,2,2},depth=25}};
%%
%\pic[shift={(-2.5,0,0)}] at (grb3-west) {LeftBandedCylinder={name=gc3,%
	%xlabel={{"32","dummy"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	%opacity=0.5,height=25,width={2},depth=25}};
%%
\pic[shift={(-1,-6,0)}] at (grb3-west) {Cylinder={name=fv3,%
	xlabel={{"3","dummy"}},fill=\GraphConvColor,
	opacity=0.5,height=25,width={1},depth=25}};
%% step 4
\pic[shift={(-5.5,0,0)}] at (grb3-west) {LeftBandedCylinder={name=grb4,caption=x3,%
	xlabel={{"32", "32","32"}},fill=\GraphConvColor,bandfill=\GraphReluColor,
	opacity=0.5,height=25,width={1,1,1},depth=25}};
%%
\pic[shift={(-1,-6,0)}] at (grb4-west) {Cylinder={name=fv4,%
	xlabel={{"3","dummy"}},fill=\GraphConvColor,
	opacity=0.5,height=25,width={1},depth=25}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw layer-to-layer connections
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (c1-east)    -- node {\midarrow} (rb1-west);
\draw [connection]  (p1-east)    -- node {\midarrow} (rb2-west);
\draw [connection]  (p2-east)    -- node {\midarrow} (rb3-west);
\draw [connection]  (p3-east)    -- node {\midarrow} (rb4-west);
\draw [connection]  (p4-east)    -- node {\midarrow} (rb5-west);
\draw [connection]  (rb5-east)    -- node {\midarrow} (up4-west);
\draw [connection]  (urb4-east)    -- node {\midarrow} (up3-west);
\draw [connection]  (urb3-east)    -- node {\midarrow} (up2-west);
\draw [connection]  (urb2-east)    -- node {\midarrow} (up1-west);
\draw [connection]  (urb1-east)    -- node {\midarrow} (cf-west);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw feature balls
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\coordinate (f1-co) at ([yshift=-70] rb1-southeast);
\pic at (f1-co) {Ball={name=f1,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f1}};
\draw [connection] (rb1-southeast) -- node {\midarrow} (f1-north);
%
\coordinate (f2-co) at (f1-anchor -| rb2-southeast);
\pic at (f2-co) {Ball={name=f2,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f2}};
\draw [connection] (rb2-southeast) -- node {\midarrow} (f2-north);
%
\coordinate (f3-co) at (f1-anchor -| rb3-southeast);
\pic at (f3-co) {Ball={name=f3,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f3}};
\draw [connection] (rb3-southeast) -- node {\midarrow} (f3-north);
%
\coordinate (f4-co) at (f1-anchor -| rb4-southeast);
\pic at (f4-co) {Ball={name=f4,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f4}};
\draw [connection] (rb4-southeast) -- node {\midarrow} (f4-north);
%
\coordinate (f5-co) at (f1-anchor -| rb5-southeast);
\pic at (f5-co) {Ball={name=f5,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f5}};
\draw [connection] (rb5-southeast) -- node {\midarrow} (f5-north);
%
\coordinate (f6-co) at (f1-anchor -| urb4-southeast);
\pic at (f6-co) {Ball={name=f6,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f6}};
\draw [connection] (urb4-southeast) -- node {\midarrow} (f6-north);
%
\coordinate (f7-co) at (f1-anchor -| urb3-southeast);
\pic at (f7-co) {Ball={name=f7,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f7}};
\draw [connection] (urb3-southeast) -- node {\midarrow} (f7-north);
%
\coordinate (f8-co) at (f1-anchor -| urb2-southeast);
\pic at (f8-co) {Ball={name=f8,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f8}};
\draw [connection] (urb2-southeast) -- node {\midarrow} (f8-north);
%
\coordinate (f9-co) at (f1-anchor -| urb1-southeast);
\pic at (f9-co) {Ball={name=f9,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f9}};
\draw [connection] (urb1-southeast) -- node {\midarrow} (f9-north);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw graph layer to layer connections
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\path (grb0-west) -- (grb1-east) coordinate[pos=0.5] (co-gcat01);
\pic at (co-gcat01) {Ball={name=gcat01,%
        fill=\CatColor,opacity=0.6,%
        radius=2.5,logo=cat}};
\draw [connection] (grb0-west) -- node{\midarrow} (gcat01-east);
\draw [connection] (gcat01-west) -- node{\midarrow} (grb1-east);
\path (grb1-west) -- (grb2-east) coordinate[pos=0.1] (co-split01);
\draw [connection] (co-split01)
	-- (fv1-east -| co-split01)
	-- node {\midarrow} (fv1-east);
%%
\path (grb1-west) -- (grb2-east) coordinate[pos=0.5] (co-gcat02);
\pic at (co-gcat02) {Ball={name=gcat02,%
        fill=\CatColor,opacity=0.6,%
        radius=2.5,logo=cat}};
\draw [connection] (grb1-west) -- node{\midarrow} (gcat02-east);
\draw [connection] (gcat02-west) -- node{\midarrow} (grb2-east);
\path (grb2-west) -- (grb3-east) coordinate[pos=0.1] (co-split02);
\draw [connection] (co-split02)
	-- (fv2-east -| co-split02)
	-- node {\midarrow} (fv2-east);
\coordinate (co-split02a) at (gcat02-south |- fv1-west);
\draw [connection] (fv1-west)
	-- node {\midarrow} (co-split02a)
	-- node {\midarrow} (gcat02-south);
\draw [connection, -Stealth] (co-split02a) -- coordinate (mout-01) ([yshift=-20] co-split02a);
%%
\path (grb2-west) -- (grb3-east) coordinate[pos=0.5] (co-gcat03);
\pic at (co-gcat03) {Ball={name=gcat03,%
        fill=\CatColor,opacity=0.6,%
        radius=2.5,logo=cat}};
\draw [connection] (grb2-west) -- node{\midarrow} (gcat03-east);
\draw [connection] (gcat03-west) -- node{\midarrow} (grb3-east);
\path (grb3-west) -- (grb4-east) coordinate[pos=0.1] (co-split03);
\draw [connection] (co-split03)
	-- (fv3-east -| co-split03)
	-- node {\midarrow} (fv3-east);
\coordinate (co-split03a) at (gcat03-south |- fv2-west);
\draw [connection] (fv2-west)
	-- node {\midarrow} (co-split03a)
	-- node {\midarrow} (gcat03-south);
\draw [connection, -Stealth] (co-split03a) -- coordinate (mout-02) ([yshift=-20] co-split03a);
%%
\path (grb3-west) -- (grb4-east) coordinate[pos=0.5] (co-gcat04);
\pic at (co-gcat04) {Ball={name=gcat04,%
        fill=\CatColor,opacity=0.6,%
        radius=2.5,logo=cat}};
\draw [connection] (grb3-west) -- node{\midarrow} (gcat04-east);
\draw [connection] (gcat04-west) -- node{\midarrow} (grb4-east);
\coordinate (co-split04) at ([xshift=-10pt] grb4-west);
\draw [connection] (grb4-west)
	-- (co-split04)
	-- (fv4-east -| co-split04)
	-- node {\midarrow} (fv4-east);
\coordinate (co-split04a) at (gcat04-south |- fv3-west);
\draw [connection] (fv3-west)
	-- node {\midarrow} (co-split04a)
	-- node {\midarrow} (gcat04-south);
\draw [connection, -Stealth] (co-split04a) -- coordinate (mout-03) ([yshift=-20] co-split04a);
\draw [connection, -Stealth] (fv4-west) -| coordinate (mout-04) ([xshift=-40, yshift=-20] fv4-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw features to graph cat
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\coordinate (cat01-topright) at ([yshift=80pt, xshift=20pt] gcat01-north);
\coordinate (cat01-topleft) at ([yshift=80pt, xshift=-20pt] gcat01-north);
\coordinate (cat01-toprightright) at ([yshift=80pt, xshift=40pt] gcat01-north);
\coordinate (cat01-topleftleft) at ([yshift=80pt, xshift=-40pt] gcat01-north);
\coordinate (f7-01-co) at (cat01-toprightright);
\coordinate (f6-01-co) at (cat01-topright);
\coordinate (f5-01-co) at (cat01-topleft);
\coordinate (f4-01-co) at (cat01-topleftleft);
\pic at (f7-01-co) {Ball={name=f7-01,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f7}};
\draw [connection] (f7-01-south) -- node {\midarrow} (gcat01-north);
\pic at (f6-01-co) {Ball={name=f6-01,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f6}};
\draw [connection] (f6-01-south) -- node {\midarrow} (gcat01-north);
\pic at (f5-01-co) {Ball={name=f5-01,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f5}};
\draw [connection] (f5-01-south) -- node {\midarrow} (gcat01-north);
\pic at (f4-01-co) {Ball={name=f4-01,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f4}};
\draw [connection] (f4-01-south) -- node {\midarrow} (gcat01-north);
%
\coordinate (cat02-topright) at ([yshift=80pt, xshift=20pt] gcat02-north);
\coordinate (cat02-topleft) at ([yshift=80pt, xshift=-20pt] gcat02-north);
\coordinate (cat02-toprightright) at ([yshift=80pt, xshift=40pt] gcat02-north);
\coordinate (cat02-topleftleft) at ([yshift=80pt, xshift=-40pt] gcat02-north);
\coordinate (f8-02-co) at (cat02-toprightright);
\coordinate (f7-02-co) at (cat02-topright);
\coordinate (f4-02-co) at (cat02-topleft);
\coordinate (f3-02-co) at (cat02-topleftleft);
\pic at (f7-02-co) {Ball={name=f7-02,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f7}};
\draw [connection] (f7-02-south) -- node {\midarrow} (gcat02-north);
\pic at (f8-02-co) {Ball={name=f8-02,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f8}};
\draw [connection] (f8-02-south) -- node {\midarrow} (gcat02-north);
\pic at (f3-02-co) {Ball={name=f3-02,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f3}};
\draw [connection] (f3-02-south) -- node {\midarrow} (gcat02-north);
\pic at (f4-02-co) {Ball={name=f4-02,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f4}};
\draw [connection] (f4-02-south) -- node {\midarrow} (gcat02-north);
%
\coordinate (cat03-topright) at ([yshift=80pt, xshift=20pt] gcat03-north);
\coordinate (cat03-topleft) at ([yshift=80pt, xshift=-20pt] gcat03-north);
\coordinate (cat03-toprightright) at ([yshift=80pt, xshift=40pt] gcat03-north);
\coordinate (cat03-topleftleft) at ([yshift=80pt, xshift=-40pt] gcat03-north);
\coordinate (f9-03-co) at (cat03-toprightright);
\coordinate (f8-03-co) at (cat03-topright);
\coordinate (f3-03-co) at (cat03-topleft);
\coordinate (f2-03-co) at (cat03-topleftleft);
\pic at (f8-03-co) {Ball={name=f8-03,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f8}};
\draw [connection] (f8-03-south) -- node {\midarrow} (gcat03-north);
\pic at (f9-03-co) {Ball={name=f9-03,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f9}};
\draw [connection] (f9-03-south) -- node {\midarrow} (gcat03-north);
\pic at (f2-03-co) {Ball={name=f2-03,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f2}};
\draw [connection] (f2-03-south) -- node {\midarrow} (gcat03-north);
\pic at (f3-03-co) {Ball={name=f3-03,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f3}};
\draw [connection] (f3-03-south) -- node {\midarrow} (gcat03-north);
%
\coordinate (cat04-topright) at ([yshift=80pt, xshift=20pt] gcat04-north);
\coordinate (cat04-topleft) at ([yshift=80pt, xshift=-20pt] gcat04-north);
\coordinate (cat04-toprightright) at ([yshift=80pt, xshift=40pt] gcat04-north);
\coordinate (cat04-topleftleft) at ([yshift=80pt, xshift=-40pt] gcat04-north);
\coordinate (f9-04-co) at (cat04-toprightright);
\coordinate (f8-04-co) at (cat04-topright);
\coordinate (f2-04-co) at (cat04-topleft);
\coordinate (f1-04-co) at (cat04-topleftleft);
\pic at (f8-04-co) {Ball={name=f8-04,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f8}};
\draw [connection] (f8-04-south) -- node {\midarrow} (gcat04-north);
\pic at (f9-04-co) {Ball={name=f9-04,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f9}};
\draw [connection] (f9-04-south) -- node {\midarrow} (gcat04-north);
\pic at (f1-04-co) {Ball={name=f1-04,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f1}};
\draw [connection] (f1-04-south) -- node {\midarrow} (gcat04-north);
\pic at (f2-04-co) {Ball={name=f2-04,%
        fill=\FeatureColor,opacity=0.6,%
        radius=1.5,logo=f2}};
\draw [connection] (f2-04-south) -- node {\midarrow} (gcat04-north);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw connections to deep supervision layers
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (f8-south) -- (f8-south |- uds2-west) -- node {\midarrow} (uds2-west);
\draw [connection]  (f7-south) -- (f7-south |- uds3-west) -- node {\midarrow} (uds3-west);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw skip connections
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\coordinate (grb0-topeast) at ([yshift=15pt] grb0-northeast) ;
\coordinate (grb0-topwest) at ([yshift=15pt, xshift=12pt] grb0-northwest) ;
\coordinate (grb0-northmiddlewest) at ([xshift=12pt] grb0-northwest);
%%
\coordinate (grb1-topeast) at ([yshift=15pt] grb1-northeast) ;
\coordinate (grb1-topwest) at ([yshift=15pt, xshift=5pt] grb1-northwest) ;
\coordinate (grb1-northmiddlewest) at ([xshift=5pt] grb1-northwest);
%%
%\coordinate (gc1-topeast) at ([yshift=15pt] gc1-northeast) ;
%\coordinate (gc1-topwest) at ([yshift=15pt, xshift=5pt] gc1-northwest) ;
%\coordinate (gc1-northmiddlewest) at ([xshift=5pt] gc1-northwest);
%%
\coordinate (grb2-topeast) at ([yshift=15pt] grb2-northeast) ;
\coordinate (grb2-topwest) at ([yshift=15pt, xshift=3pt] grb2-northwest) ;
\coordinate (grb2-northmiddlewest) at ([xshift=3pt] grb2-northwest);
%%
%\coordinate (gc2-topeast) at ([yshift=15pt] gc2-northeast) ;
%\coordinate (gc2-topwest) at ([yshift=15pt, xshift=3pt] gc2-northwest) ;
%\coordinate (gc2-northmiddlewest) at ([xshift=3pt] gc2-northwest);
%%
\coordinate (grb3-topeast) at ([yshift=15pt] grb3-northeast) ;
\coordinate (grb3-topwest) at ([yshift=15pt, xshift=3pt] grb3-northwest) ;
\coordinate (grb3-northmiddlewest) at ([xshift=3pt] grb3-northwest);
%%
%\coordinate (gc3-topeast) at ([yshift=15pt] gc3-northeast) ;
%\coordinate (gc3-topwest) at ([yshift=15pt, xshift=3pt] gc3-northwest) ;
%\coordinate (gc3-northmiddlewest) at ([xshift=3pt] gc3-northwest);
%%
\coordinate (grb4-topeast) at ([yshift=15pt] grb4-northeast) ;
\coordinate (grb4-topwest) at ([yshift=15pt, xshift=2pt] grb4-northwest) ;
\coordinate (grb4-northmiddlewest) at ([xshift=2pt] grb4-northwest);
%%
\path (rb1-southwest) -- (rb1-north) coordinate[pos=1.25] (rb1-topeast) ;
\path (rb1-southwest) -- (rb1-northwest) coordinate[pos=1.25] (rb1-topwest) ;
\path (rb1-northwest) -- (rb1-south) coordinate[pos=1.25] (rb1-bottomeast) ;
\coordinate (rb1-northmiddleeast) at (intersection of rb1-topeast--rb1-bottomeast and rb1-northwest--rb1-northeast);
\path (rb1-southeast) -- (rb1-northeast) coordinate[pos=1.25] (rb1-topeasteast);
%%
\path (rb2-southwest) -- (rb2-north) coordinate[pos=1.25] (rb2-topeast) ;
\path (rb2-southwest) -- (rb2-northwest) coordinate[pos=1.25] (rb2-topwest) ;
\path (rb2-northwest) -- (rb2-south) coordinate[pos=1.25] (rb2-bottomeast) ;
\coordinate (rb2-northmiddleeast) at (intersection of rb2-topeast--rb2-bottomeast and rb2-northwest--rb2-northeast);
\path (rb2-southeast) -- (rb2-northeast) coordinate[pos=1.25] (rb2-topeasteast);
%%
\path (rb3-southwest) -- (rb3-north) coordinate[pos=1.25] (rb3-topeast) ;
\path (rb3-southwest) -- (rb3-northwest) coordinate[pos=1.25] (rb3-topwest) ;
\path (rb3-northwest) -- (rb3-south) coordinate[pos=1.25] (rb3-bottomeast) ;
\coordinate (rb3-northmiddleeast) at (intersection of rb3-topeast--rb3-bottomeast and rb3-northwest--rb3-northeast);
\path (rb3-southeast) -- (rb3-northeast) coordinate[pos=1.25] (rb3-topeasteast);
%%
\path (rb4-southwest) -- (rb4-north) coordinate[pos=1.25] (rb4-topeast) ;
\path (rb4-southwest) -- (rb4-northwest) coordinate[pos=1.25] (rb4-topwest) ;
\path (rb4-northwest) -- (rb4-south) coordinate[pos=1.25] (rb4-bottomeast) ;
\coordinate (rb4-northmiddleeast) at (intersection of rb4-topeast--rb4-bottomeast and rb4-northwest--rb4-northeast);
\path (rb4-southeast) -- (rb4-northeast) coordinate[pos=1.25] (rb4-topeasteast);
%%
\path (rb5-southwest) -- (rb5-north) coordinate[pos=1.25] (rb5-topeast) ;
\path (rb5-southwest) -- (rb5-northwest) coordinate[pos=1.25] (rb5-topwest) ;
\path (rb5-northwest) -- (rb5-south) coordinate[pos=1.25] (rb5-bottomeast) ;
\coordinate (rb5-northmiddleeast) at (intersection of rb5-topeast--rb5-bottomeast and rb5-northwest--rb5-northeast);
%%
\path (urb1-southwest) -- (urb1-north) coordinate[pos=1.25] (urb1-topeast) ;
\path (urb1-southwest) -- (urb1-northwest) coordinate[pos=1.25] (urb1-topwest) ;
\path (urb1-northwest) -- (urb1-south) coordinate[pos=1.25] (urb1-bottomeast) ;
\coordinate (urb1-northmiddleeast) at (intersection of urb1-topeast--urb1-bottomeast and urb1-northwest--urb1-northeast);
\path (urb1-east) -- (urb1-northwest) coordinate[pos=1.5] (urb1-topwestwest);
%%
\path (urb2-southwest) -- (urb2-north) coordinate[pos=1.25] (urb2-topeast) ;
\path (urb2-southwest) -- (urb2-northwest) coordinate[pos=1.25] (urb2-topwest) ;
\path (urb2-northwest) -- (urb2-south) coordinate[pos=1.25] (urb2-bottomeast) ;
\coordinate (urb2-northmiddleeast) at (intersection of urb2-topeast--urb2-bottomeast and urb2-northwest--urb2-northeast);
\path (urb2-east) -- (urb2-northwest) coordinate[pos=1.5] (urb2-topwestwest);
%%
\path (urb3-southwest) -- (urb3-north) coordinate[pos=1.25] (urb3-topeast) ;
\path (urb3-southwest) -- (urb3-northwest) coordinate[pos=1.25] (urb3-topwest) ;
\path (urb3-northwest) -- (urb3-south) coordinate[pos=1.25] (urb3-bottomeast) ;
\coordinate (urb3-northmiddleeast) at (intersection of urb3-topeast--urb3-bottomeast and urb3-northwest--urb3-northeast);
\path (urb3-east) -- (urb3-northwest) coordinate[pos=1.5] (urb3-topwestwest);
%%
\path (urb4-southwest) -- (urb4-north) coordinate[pos=1.25] (urb4-topeast) ;
\path (urb4-southwest) -- (urb4-northwest) coordinate[pos=1.25] (urb4-topwest) ;
\path (urb4-northwest) -- (urb4-south) coordinate[pos=1.25] (urb4-bottomeast) ;
\coordinate (urb4-northmiddleeast) at (intersection of urb4-topeast--urb4-bottomeast and urb4-northwest--urb4-northeast);
\path (urb4-east) -- (urb4-northwest) coordinate[pos=1.5] (urb4-topwestwest);
%% Residual layer skips
\draw [copyconnection]  (grb0-northeast)  
-- node {\copymidarrow}(grb0-topeast)
-- node {\copymidarrow}(grb0-topwest)
-- node {\copymidarrow} (grb0-northmiddlewest);
%%
\draw [copyconnection]  (grb1-northeast)  
-- node {\copymidarrow}(grb1-topeast)
-- node {\copymidarrow}(grb1-topwest)
-- node {\copymidarrow} (grb1-northmiddlewest);
%%
%\draw [copyconnection]  (gc1-northeast)  
%-- node {\copymidarrow}(gc1-topeast)
%-- node {\copymidarrow}(gc1-topwest)
%-- node {\copymidarrow} (gc1-northmiddlewest);
%%
\draw [copyconnection]  (grb2-northeast)  
-- node {\copymidarrow}(grb2-topeast)
-- node {\copymidarrow}(grb2-topwest)
-- node {\copymidarrow} (grb2-northmiddlewest);
%%
%\draw [copyconnection]  (gc2-northeast)  
%-- node {\copymidarrow}(gc2-topeast)
%-- node {\copymidarrow}(gc2-topwest)
%-- node {\copymidarrow} (gc2-northmiddlewest);
%%
\draw [copyconnection]  (grb3-northeast)  
-- node {\copymidarrow}(grb3-topeast)
-- node {\copymidarrow}(grb3-topwest)
-- node {\copymidarrow} (grb3-northmiddlewest);
%%
%\draw [copyconnection]  (gc3-northeast)  
%-- node {\copymidarrow}(gc3-topeast)
%-- node {\copymidarrow}(gc3-topwest)
%-- node {\copymidarrow} (gc3-northmiddlewest);
%%
\draw [copyconnection]  (grb4-northeast)  
-- node {\copymidarrow}(grb4-topeast)
-- node {\copymidarrow}(grb4-topwest)
-- node {\copymidarrow} (grb4-northmiddlewest);
%%
\draw [copyconnection]  (rb1-northwest)  
-- node {\copymidarrow}(rb1-topwest)
-- node {\copymidarrow}(rb1-topeast)
-- node {\copymidarrow} (rb1-northmiddleeast);
%%
\draw [copyconnection]  (rb2-northwest)  
-- node {\copymidarrow}(rb2-topwest)
-- node {\copymidarrow}(rb2-topeast)
-- node {\copymidarrow} (rb2-northmiddleeast);
%%
\draw [copyconnection]  (rb3-northwest)  
-- node {\copymidarrow}(rb3-topwest)
-- node {\copymidarrow}(rb3-topeast)
-- node {\copymidarrow} (rb3-northmiddleeast);
%%
\draw [copyconnection]  (rb4-northwest)  
-- node {\copymidarrow}(rb4-topwest)
-- node {\copymidarrow}(rb4-topeast)
-- node {\copymidarrow} (rb4-northmiddleeast);
%%
\draw [copyconnection]  (rb5-northwest)  
-- node {\copymidarrow}(rb5-topwest)
-- node {\copymidarrow}(rb5-topeast)
-- node {\copymidarrow} (rb5-northmiddleeast);
%%
\draw [copyconnection]  (urb1-northwest)  
-- node {\copymidarrow}(urb1-topwest)
-- node {\copymidarrow}(urb1-topeast)
-- node {\copymidarrow} (urb1-northmiddleeast);
%%
\draw [copyconnection]  (urb2-northwest)  
-- node {\copymidarrow}(urb2-topwest)
-- node {\copymidarrow}(urb2-topeast)
-- node {\copymidarrow} (urb2-northmiddleeast);
%%
\draw [copyconnection]  (urb3-northwest)  
-- node {\copymidarrow}(urb3-topwest)
-- node {\copymidarrow}(urb3-topeast)
-- node {\copymidarrow} (urb3-northmiddleeast);
%%
\draw [copyconnection]  (urb4-northwest)  
-- node {\copymidarrow}(urb4-topwest)
-- node {\copymidarrow}(urb4-topeast)
-- node {\copymidarrow} (urb4-northmiddleeast);
%% Encoder-decoder skips
\draw [copyconnection]  (rb1-northeast)
-- node {\copymidarrow}(rb1-topeasteast)
-- node {\copymidarrow}(urb1-topwestwest)
-- node {\copymidarrow} (urb1-northwest);
%%
\draw [copyconnection]  (rb2-northeast)
-- node {\copymidarrow}(rb2-topeasteast)
-- node {\copymidarrow}(urb2-topwestwest)
-- node {\copymidarrow} (urb2-northwest);
%%
\draw [copyconnection]  (rb3-northeast)
-- node {\copymidarrow}(rb3-topeasteast)
-- node {\copymidarrow}(urb3-topwestwest)
-- node {\copymidarrow} (urb3-northwest);
%%
\draw [copyconnection]  (rb4-northeast)
-- node {\copymidarrow}(rb4-topeasteast)
-- node {\copymidarrow}(urb4-topwestwest)
-- node {\copymidarrow} (urb4-northwest);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Mesh template
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pic[shift={(4,0,2)}] at (grb0-east) {Ball={name=template,%
	fill={rgb:black,5}, logo= ,%
        radius=10}};
\pic[shift={(4,0,-2)}] at (grb0-east) {Ball={name=template-2,%
	fill={rgb:black,5}, logo= ,%
        radius=10}};
\draw [connection] ([xshift=100] grb0-east) -- node {\midarrow} (grb0-east);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Output meshes and images
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\node[inner sep=0pt] (img-in) at ([xshift=-100] c1-west)
    {\includegraphics[width=.25\textwidth]{mri.png}};
\draw [connection] (img-in.east) -- node {\midarrow} (c1-west);
\node[inner sep=0pt] (img-out-1) at ([xshift=100] cf-east)
	{\includegraphics[width=.25\textwidth]{segmap.png}};
\draw [connection] (cf-east) -- node {\midarrow} (img-out-1.west);
\node[inner sep=0pt] (img-out-2) at ([xshift=100] ds2-east)
	{\includegraphics[width=.25\textwidth]{segmap.png}};
\draw [connection] (ds2-east) -- node {\midarrow} (img-out-2.west);
\node[inner sep=0pt] (img-out-3) at ([xshift=100] ds3-east)
	{\includegraphics[width=.25\textwidth]{segmap.png}};
\draw [connection] (ds3-east) -- node {\midarrow} (img-out-3.west);
\node[inner sep=0pt] (mout1) at ([yshift=-50, xshift=-30] mout-01)
    {\includegraphics[width=.25\textwidth]{step_1.png}};
\node[inner sep=0pt] (mout2) at ([yshift=-50, xshift=-30] mout-02)
    {\includegraphics[width=.25\textwidth]{step_2.png}};
\node[inner sep=0pt] (mout3) at ([yshift=-50, xshift=-30] mout-03)
    {\includegraphics[width=.25\textwidth]{step_3.png}};
\node[inner sep=0pt] (mout4) at ([yshift=-60, xshift=-30] mout-04)
    {\includegraphics[width=.25\textwidth]{step_4.png}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw legend
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tikzset{rectnode/.style = {rectangle, rounded corners=0pt, minimum width = 10pt, minimum height = 10pt}}
\coordinate (legend-northwest) at ([yshift=-200pt,xshift=50pt] gcat01-south);
\matrix[matrix of nodes, nodes={opacity=0.9, draw=none},
	column 2/.style={anchor=west}, draw=black, densely dashed, thick, rounded corners,
        row sep=5pt,column sep=10pt, rectangle] at (legend-northwest) {
		\node[rectnode,fill=\ConvColor]{}; &
		\node[fill=none] {Conv 3x3x3}; \\
		\node[rectnode,fill=\ConvReluColor]{}; &
		\node[fill=none] {BatchNorm3d + ReLU}; \\
		\node[rectnode,fill=\PoolColor]{}; &
		\node[fill=none] {Conv 2x2x2, stride 2};\\
		\node[rectnode,fill=\UnpoolColor]{}; &
		\node[fill=none] {ConvTranspose 2x2x2, stride 2}; \\
		\node[rectnode,fill=\ConvKOneColor]{}; &
		\node[fill=none] {Conv 1x1x1}; \\
		\node[rectnode,fill=\UpsampleColor]{}; &
		\node[fill=none] {Upsample trilinear};\\
		\node[ellipse,fill=\GraphConvColor]{}; &
		\node[fill=none] {Graph conv};\\
		\node[ellipse,fill=\GraphReluColor]{}; &
		\node[fill=none] {BatchNorm1d + ReLU};\\
	};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{tikzpicture}
\end{document}
